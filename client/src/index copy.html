<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker - Team Access Required</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0iIzY2N2VlYSIvPgo8dGV4dCB4PSIxNiIgeT0iMjAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfgYc8L3RleHQ+Cjwvc3ZnPgo=">
    <style>
        /* Modern CSS with beautiful card design + All UI Enhancements */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        /* Join Interface Styles */
        #joinInterface {
            display: block;
        }

        #joinForm {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* Password Button Styles */
        #teamPasswordBtn {
            width: 100%;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        #teamPasswordBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.3);
        }

        #teamPasswordBtn.authenticated {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            cursor: default;
        }

        #teamPasswordBtn.authenticated:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        /* Join Button Styles */
        #joinButton {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #joinButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        #joinButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Game Interface Styles */
        #gameInterface {
            display: none;
        }

        .session-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .session-info h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .session-code {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 3px;
            margin: 10px 0;
        }

        .share-link {
            display: inline-block;
            background: #667eea;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            margin: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .share-link:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        /* Voting Cards */
        .voting-section {
            margin-bottom: 30px;
        }

        .fibonacci-cards {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .fibonacci-card {
            width: 90px;
            height: 130px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .fibonacci-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s ease;
        }

        .fibonacci-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
            border-color: #5a67d8;
        }

        .fibonacci-card:hover::before {
            animation: shimmer 0.6s ease-in-out;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .fibonacci-card.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #5a67d8;
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        .fibonacci-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .fibonacci-card.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .fibonacci-card.re-vote-allowed {
            border-color: #ffc107;
            animation: pulse-yellow 2s infinite;
        }

        @keyframes pulse-yellow {
            0%, 100% { border-color: #ffc107; box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            50% { border-color: #e0a800; box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        }

        /* Players Display */
        #playerCards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .player-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }

        .player-card.spectator::before {
            background: linear-gradient(90deg, #6c757d, #495057);
        }

        .vote-card {
            width: 60px;
            height: 85px;
            margin: 15px auto;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .vote-card.hidden {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .vote-card.revealed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: flip 0.6s ease-in-out;
        }

        .vote-card.no-vote {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }

        /* Game Status */
        #gameStatus {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .consensus {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            animation: celebration 2s ease-in-out;
        }

        .no-consensus {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .waiting {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
        }

        @keyframes celebration {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Spectator Controls - SINGLE BUTTON ONLY */
        .spectator-controls {
            text-align: center;
            margin-top: 20px;
        }

        #resetButton {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        #resetButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
        }

        /* Password Modal Styles */
        .password-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .password-modal {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }

        .password-modal h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .password-modal p {
            color: #6c757d;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .password-modal input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .password-modal input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
        }

        .btn-primary, .btn-secondary {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .password-error {
            color: #dc3545;
            font-weight: 500;
            margin-top: 15px;
            padding: 10px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 8px;
        }

        /* Temporary Message System */
        .temporary-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
            z-index: 1000;
            animation: slide-in 0.3s ease-out, slide-out 0.3s ease-in 2.7s forwards;
            max-width: 300px;
        }

        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slide-out {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Error and Loading States */
        #errorMessage {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            animation: shake 0.5s ease-in-out;
            display: none;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        #loadingState {
            text-align: center;
            padding: 30px;
            color: #667eea;
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .content {
                padding: 30px 20px;
            }

            .fibonacci-cards {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .fibonacci-card {
                width: 70px;
                height: 100px;
                font-size: 20px;
            }

            #playerCards {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
            }

            .player-card {
                padding: 15px;
            }

            .vote-card {
                width: 50px;
                height: 70px;
                font-size: 1.2rem;
            }

            .temporary-message {
                top: 10px;
                right: 10px;
                left: 10px;
                padding: 12px 20px;
                font-size: 14px;
                max-width: none;
            }

            .session-info {
                padding: 20px;
            }

            .session-code {
                font-size: 1.5rem;
                letter-spacing: 2px;
            }
        }

        /* Accessibility improvements */
        .fibonacci-card:focus,
        #resetButton:focus,
        .btn-primary:focus,
        .btn-secondary:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .fibonacci-card {
                border-width: 4px;
            }
            
            .consensus,
            .no-consensus,
            .temporary-message {
                border: 3px solid currentColor;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Planning Poker</h1>
            <p>Agile Story Point Estimation Tool</p>
        </div>

        <div class="content">
            <!-- Join Interface -->
            <div id="joinInterface">
                <form id="joinForm">
                    <div class="form-group">
                        <button type="button" id="teamPasswordBtn">üîí Enter Team Password</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="playerName">Your Name</label>
                        <input type="text" id="playerName" placeholder="Enter your name" maxlength="20" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="sessionCode">Session Code (leave empty to create new)</label>
                        <input type="text" id="sessionCode" placeholder="Enter session code or leave empty">
                        <div class="checkbox-group">
                            <input type="checkbox" id="spectatorMode">
                            <label for="spectatorMode">Join as Spectator</label>
                        </div>
                    </div>
                    
                    <button type="button" id="joinButton">üöÄ Join Session</button>
                </form>
            </div>

            <!-- Game Interface -->
            <div id="gameInterface">
                <div class="session-info">
                    <h3>Session</h3>
                    <div class="session-code" id="displaySessionCode"></div>
                    <a href="#" class="share-link" id="shareLink">üìã Copy Share Link</a>
                </div>

                <div id="errorMessage"></div>
                <div id="loadingState">
                    <div class="spinner"></div>
                    <p>Connecting to server...</p>
                </div>

                <div id="gameStatus" class="waiting">Waiting for players to join...</div>

                <div class="voting-section">
                    <h3>Cast Your Vote</h3>
                    <div class="fibonacci-cards">
                        <div class="fibonacci-card" data-value="1">1</div>
                        <div class="fibonacci-card" data-value="2">2</div>
                        <div class="fibonacci-card" data-value="3">3</div>
                        <div class="fibonacci-card" data-value="5">5</div>
                        <div class="fibonacci-card" data-value="8">8</div>
                        <div class="fibonacci-card" data-value="13">13</div>
                    </div>
                </div>

                <div id="playersSection">
                    <h3>Players</h3>
                    <div id="playerCards"></div>
                </div>

                <!-- Single Reset Button for Spectators -->
                <div class="spectator-controls">
                    <button id="resetButton">üîÑ Reset Votes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        // Global game state
        var gameState = {
            socket: null,
            isConnected: false,
            sessionState: {
                players: {},
                votesRevealed: false,
                hasConsensus: false
            },
            isSpectator: false,
            playerName: '',
            currentVote: null
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Planning Poker app initializing...');
            setupEventListeners();
            checkAuthentication();
            connectToServer();
            
            // Check URL parameters for session joining
            var urlParams = new URLSearchParams(window.location.search);
            var sessionCode = urlParams.get('session');
            if (sessionCode) {
                console.log('üîó Session code found in URL:', sessionCode);
                document.getElementById('sessionCode').value = sessionCode;
                
                // Show a helpful message about joining shared session
                showTemporaryMessage('üîó Joining shared session: ' + sessionCode);
            }
        });

        // Setup event listeners
        function setupEventListeners() {
            // Team password button
            var teamPasswordBtn = document.getElementById('teamPasswordBtn');
            if (teamPasswordBtn) {
                teamPasswordBtn.addEventListener('click', handlePasswordAuth);
            }
            
            // Join button
            document.getElementById('joinButton').addEventListener('click', joinSession);
            
            // Single reset button (removed duplicate)
            var resetButton = document.getElementById('resetButton');
            if (resetButton) {
                resetButton.addEventListener('click', resetVotes);
            }
            
            // Voting cards
            var fibonacciCards = document.querySelectorAll('.fibonacci-card');
            for (var i = 0; i < fibonacciCards.length; i++) {
                fibonacciCards[i].addEventListener('click', function() {
                    var value = parseInt(this.dataset.value);
                    castVote(value);
                });
            }
            
            // Share link copy functionality
            document.getElementById('shareLink').addEventListener('click', copyShareLink);
            
            // Enter key to join
            document.getElementById('playerName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    joinSession();
                }
            });
        }

        // Authentication functions
        function checkAuthentication() {
            // ALWAYS clear authentication on page load to ensure proper testing
            localStorage.removeItem('planningPoker_authenticated');
            
            var isAuthenticated = localStorage.getItem('planningPoker_authenticated') === 'true';
            var teamPasswordBtn = document.getElementById('teamPasswordBtn');
            
            console.log('Authentication check - isAuthenticated:', isAuthenticated);
            
            if (isAuthenticated) {
                // Hide button if already authenticated
                teamPasswordBtn.style.display = 'none';
                console.log('Button hidden - already authenticated');
            } else {
                // Show red button requiring authentication
                teamPasswordBtn.textContent = 'Enter Team Password';
                teamPasswordBtn.className = '';
                teamPasswordBtn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                teamPasswordBtn.style.color = 'white';
                teamPasswordBtn.style.cursor = 'pointer';
                teamPasswordBtn.style.display = 'block';
                teamPasswordBtn.style.opacity = '1';
                teamPasswordBtn.style.transform = 'scale(1)';
                console.log('Button set to unauthenticated state (red - requires password)');
            }
        }

        function showPasswordField() {
            // Password field is always visible as button, no changes needed
        }

        function hidePasswordField() {
            // Keep button visible but it shows authenticated state
        }

        function handlePasswordAuth() {
            var isAuthenticated = localStorage.getItem('planningPoker_authenticated') === 'true';
            
            if (isAuthenticated) {
                showTemporaryMessage('‚úÖ Already authenticated!');
                return;
            }
            
            showPasswordModal();
        }

        function showPasswordModal() {
            var existingModal = document.querySelector('.password-modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }

            var modalOverlay = document.createElement('div');
            modalOverlay.className = 'password-modal-overlay';
            modalOverlay.innerHTML = 
                '<div class="password-modal">' +
                    '<h3>üîí Enter Team Password</h3>' +
                    '<p>Please enter the team password to access Planning Poker:</p>' +
                    '<input type="password" id="passwordInput" placeholder="Enter password" maxlength="50">' +
                    '<div class="modal-buttons">' +
                        '<button id="submitPassword" class="btn-primary">Submit</button>' +
                        '<button id="cancelPassword" class="btn-secondary">Cancel</button>' +
                    '</div>' +
                    '<div id="passwordError" class="password-error" style="display: none;"></div>' +
                '</div>';
            
            document.body.appendChild(modalOverlay);
            
            var passwordInput = document.getElementById('passwordInput');
            passwordInput.focus();
            
            document.getElementById('submitPassword').addEventListener('click', validatePassword);
            document.getElementById('cancelPassword').addEventListener('click', closePasswordModal);
            
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    validatePassword();
                }
            });
            
            var escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    closePasswordModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }

        function validatePassword() {
            var passwordInput = document.getElementById('passwordInput');
            var enteredPassword = passwordInput.value.trim();
            var passwordError = document.getElementById('passwordError');
            
            // Clear any existing errors
            passwordError.style.display = 'none';
            passwordError.textContent = '';
            
            if (!enteredPassword) {
                passwordError.textContent = '‚ùå Please enter a password.';
                passwordError.style.display = 'block';
                passwordInput.focus();
                return;
            }
            
            var correctPassword = 'team2024';
            
            if (enteredPassword === correctPassword) {
                // Set authentication in localStorage
                localStorage.setItem('planningPoker_authenticated', 'true');
                console.log('‚úÖ Password correct, localStorage set');
                
                // Close modal first
                closePasswordModal();
                
                // Hide the password button completely after successful authentication
                setTimeout(function() {
                    var teamPasswordBtn = document.getElementById('teamPasswordBtn');
                    if (teamPasswordBtn) {
                        // Hide button with smooth fade out
                        teamPasswordBtn.style.opacity = '0';
                        teamPasswordBtn.style.transform = 'scale(0.8)';
                        teamPasswordBtn.style.transition = 'all 0.3s ease';
                        
                        // Remove from layout after animation
                        setTimeout(function() {
                            teamPasswordBtn.style.display = 'none';
                            console.log('üîÑ Password button hidden after successful authentication');
                        }, 300);
                    } else {
                        console.error('‚ùå Could not find teamPasswordBtn element');
                    }
                }, 200);
                
                // Show success message
                showTemporaryMessage('‚úÖ Authentication successful! Password field hidden.');
                
                // Focus on name input
                focusOnPlayerName();
                
                console.log('‚úÖ Password authentication complete');
            } else {
                passwordError.textContent = '‚ùå Incorrect password. Please try again.';
                passwordError.style.display = 'block';
                passwordInput.focus();
                passwordInput.select();
                console.log('‚ùå Password authentication failed');
            }
        }

        function closePasswordModal() {
            var modalOverlay = document.querySelector('.password-modal-overlay');
            if (modalOverlay) {
                modalOverlay.remove();
            }
        }

        function focusOnPlayerName() {
            var playerNameInput = document.getElementById('playerName');
            if (playerNameInput) {
                playerNameInput.focus();
            }
        }
        
        // Debug function - you can call this in browser console to test button update
        function forceUpdatePasswordButton() {
            var teamPasswordBtn = document.getElementById('teamPasswordBtn');
            if (teamPasswordBtn) {
                teamPasswordBtn.textContent = '‚úÖ Team Password Verified';
                teamPasswordBtn.className = 'authenticated';
                teamPasswordBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                teamPasswordBtn.style.color = 'white';
                teamPasswordBtn.style.cursor = 'default';
                console.log('üîß Manual button update completed');
                return 'Button updated successfully!';
            }
            return 'Button not found!';
        }

        // Server connection
        function connectToServer() {
            showLoading();
            
            try {
                // Try to connect to production first, fallback to local
                var serverUrl = window.location.hostname === 'localhost' ? 
                    'http://localhost:3001' : 
                    'https://team2playscards.com';
                
                console.log('üîó Connecting to server:', serverUrl);
                
                gameState.socket = io(serverUrl, {
                    timeout: 10000,
                    forceNew: true,
                    transports: ['websocket', 'polling']
                });
                
                // Connection successful
                gameState.socket.on('connect', function() {
                    console.log('‚úÖ Connected to server');
                    gameState.isConnected = true;
                    hideLoading();
                    hideError();
                });
                
                // Connection failed
                gameState.socket.on('connect_error', function(error) {
                    console.error('‚ùå Connection failed:', error);
                    gameState.isConnected = false;
                    hideLoading();
                    showError('Unable to connect to server. Please check your internet connection.');
                });
                
                gameState.socket.on('disconnect', function() {
                    console.log('üîå Disconnected from server');
                    gameState.isConnected = false;
                    showError('Disconnected from server. Attempting to reconnect...');
                });
                
                // Session events
                gameState.socket.on('sessionJoined', function(data) {
                    console.log('üéâ Session joined successfully:', data);
                    gameState.sessionCode = data.sessionCode;
                    gameState.playerName = data.playerName;
                    gameState.isSpectator = data.isSpectator;
                    gameState.sessionState = data.sessionState;
                    
                    hideLoading();
                    hideError();
                    showGameInterface();
                    updateUI();
                });
                
                gameState.socket.on('sessionUpdate', function(data) {
                    console.log('üìä Session update received:', data);
                    gameState.sessionState = data;
                    updateUI();
                });
                
                gameState.socket.on('voteCast', function(data) {
                    console.log('üó≥Ô∏è Vote cast confirmed:', data);
                    gameState.currentVote = data.vote;
                    updateSelectedVote(data.vote);
                });
                
                gameState.socket.on('votesReset', function(data) {
                    console.log('üîÑ Votes reset:', data);
                    gameState.currentVote = null;
                    updateSelectedVote(null);
                });
                
                // Error handling
                gameState.socket.on('error', function(data) {
                    console.error('‚ùå Server error:', data);
                    showError(data.message || 'Server error occurred');
                    hideLoading();
                });
                
            } catch (error) {
                console.log('‚ùå Socket connection error:', error);
                hideLoading();
                showError('Failed to connect to server');
            }
        }

        // Join or create session
        function joinSession() {
            var playerName = document.getElementById('playerName').value.trim();
            var sessionCode = document.getElementById('sessionCode').value.trim();
            var isSpectator = document.getElementById('spectatorMode').checked;
            
            if (!playerName) {
                showError('Please enter your name');
                return;
            }
            
            if (playerName.length > 20) {
                showError('Name must be 20 characters or less');
                return;
            }
            
            // Check authentication
            var isAuthenticated = localStorage.getItem('planningPoker_authenticated') === 'true';
            if (!isAuthenticated) {
                showError('Please enter team password first');
                return;
            }
            
            // Generate session code if not provided
            var finalSessionCode = sessionCode || generateSessionCode();
            
            if (!gameState.isConnected) {
                // Show offline mode with session code
                console.log('üß™ No server connection - showing offline session');
                gameState.sessionCode = finalSessionCode;
                gameState.playerName = playerName; // Use original name, no random suffix
                gameState.isSpectator = isSpectator;
                
                showGameInterface();
                showTemporaryMessage('‚ö†Ô∏è Offline mode - Session created: ' + finalSessionCode);
                return;
            }
            
            showLoading();
            hideError();
            
            console.log('üéØ Joining session: ' + finalSessionCode + ' as ' + (isSpectator ? 'Spectator' : 'Player') + ' with name: ' + playerName);
            
            // Send join request to server with original name (remove random suffix)
            gameState.socket.emit('joinSession', {
                sessionCode: finalSessionCode,
                playerName: playerName, // Use original name only
                isSpectator: isSpectator
            });
        }

        // Cast a vote
        function castVote(value) {
            console.log('üó≥Ô∏è Vote button clicked: ' + value);
            
            if (!gameState.isConnected) {
                showError('Not connected to server');
                return;
            }
            
            if (gameState.isSpectator) {
                showError('Spectators cannot vote');
                return;
            }
            
            var canVote = !gameState.sessionState.hasConsensus;
            var isRevotingScenario = gameState.sessionState.votesRevealed && !gameState.sessionState.hasConsensus;
            
            if (!canVote) {
                console.log('üö´ Voting disabled - consensus already reached');
                showError('Consensus already reached. Reset votes to start new round.');
                return;
            }
            
            if (gameState.currentVote === value) {
                console.log('üîÑ Same vote clicked - no change needed');
                return;
            }
            
            // Visual feedback
            updateSelectedVote(value);
            
            // Send vote to server
            gameState.socket.emit('castVote', {
                sessionCode: gameState.sessionCode,
                playerName: gameState.playerName,
                vote: value
            });
            
            console.log('üì§ Vote sent to server: ' + value);
            
            if (isRevotingScenario) {
                showTemporaryMessage('üîÑ Vote changed to ' + value);
            } else {
                showTemporaryMessage('‚úÖ Vote cast: ' + value);
            }
        }

        // Reset votes (Spectator only)
        function resetVotes() {
            if (!gameState.isConnected) {
                showError('Not connected to server');
                return;
            }
            
            if (!gameState.isSpectator) {
                showError('Only spectators can reset votes');
                return;
            }
            
            console.log('üîÑ Resetting votes...');
            
            gameState.socket.emit('resetVotes', {
                sessionCode: gameState.sessionCode,
                playerName: gameState.playerName
            });
            
            showTemporaryMessage('üîÑ Votes reset by spectator');
        }

        // UI Management Functions
        function showGameInterface() {
            document.getElementById('joinInterface').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'block';
            
            // Update session display - ensure we have a session code
            var sessionCodeElement = document.getElementById('displaySessionCode');
            if (gameState.sessionCode) {
                sessionCodeElement.textContent = gameState.sessionCode;
            } else {
                // Fallback - generate one if missing
                gameState.sessionCode = generateSessionCode();
                sessionCodeElement.textContent = gameState.sessionCode;
                console.log('üîß Generated fallback session code:', gameState.sessionCode);
            }
            
            // Update share link
            var shareUrl = window.location.origin + window.location.pathname + '?session=' + gameState.sessionCode;
            var shareLink = document.getElementById('shareLink');
            shareLink.setAttribute('data-url', shareUrl);
            shareLink.href = shareUrl;
            
            console.log('üéÆ Game interface shown with session:', gameState.sessionCode);
        }

        function updateUI() {
            updateGameStatus();
            updatePlayerCards();
            updateVotingCards();
            updateSpectatorControls();
        }

        function updateGameStatus() {
            var statusElement = document.getElementById('gameStatus');
            var players = gameState.sessionState.players;
            var votesRevealed = gameState.sessionState.votesRevealed;
            var hasConsensus = gameState.sessionState.hasConsensus;
            
            // Count non-spectator players
            var totalPlayers = 0;
            var votedPlayers = 0;
            
            for (var playerName in players) {
                if (players.hasOwnProperty(playerName)) {
                    var player = players[playerName];
                    if (!player.isSpectator) {
                        totalPlayers++;
                        if (player.hasVoted) {
                            votedPlayers++;
                        }
                    }
                }
            }
            
            if (totalPlayers === 0) {
                statusElement.textContent = 'Waiting for players to join...';
                statusElement.className = 'waiting';
            } else if (hasConsensus && votesRevealed) {
                statusElement.innerHTML = 'üéâ Consensus Reached! Story Points: ' + getConsensusValue();
                statusElement.className = 'consensus';
            } else if (votesRevealed) {
                statusElement.textContent = '‚ùå No consensus reached. Re-vote or reset.';
                statusElement.className = 'no-consensus';
            } else {
                statusElement.textContent = 'üìä Votes: ' + votedPlayers + '/' + totalPlayers + ' cast';
                statusElement.className = 'waiting';
            }
        }

        function getConsensusValue() {
            var players = gameState.sessionState.players;
            for (var playerName in players) {
                if (players.hasOwnProperty(playerName)) {
                    var player = players[playerName];
                    if (!player.isSpectator && player.hasVoted) {
                        return player.vote;
                    }
                }
            }
            return '?';
        }

        function updatePlayerCards() {
            var container = document.getElementById('playerCards');
            var players = gameState.sessionState.players;
            var votesRevealed = gameState.sessionState.votesRevealed;
            
            // Clear existing cards
            container.innerHTML = '';
            
            // Create player cards
            for (var name in players) {
                if (!players.hasOwnProperty(name)) continue;
                
                var player = players[name];
                
                var playerDiv = document.createElement('div');
                playerDiv.className = 'player-card' + (player.isSpectator ? ' spectator' : '');
                
                var nameDiv = document.createElement('div');
                nameDiv.style.fontWeight = 'bold';
                nameDiv.style.marginBottom = '10px';
                nameDiv.textContent = name + (player.isSpectator ? ' (Spectator)' : '');
                
                var cardDiv = document.createElement('div');
                cardDiv.className = 'vote-card';
                
                if (player.isSpectator) {
                    cardDiv.classList.add('no-vote');
                    cardDiv.textContent = 'üëÅÔ∏è';
                } else if (!player.hasVoted) {
                    cardDiv.classList.add('no-vote');
                    cardDiv.textContent = '?';
                } else if (votesRevealed && player.vote !== null) {
                    cardDiv.classList.add('revealed');
                    cardDiv.textContent = player.vote;
                } else {
                    cardDiv.classList.add('hidden');
                    cardDiv.textContent = '‚úì';
                }
                
                var statusDiv = document.createElement('small');
                if (player.isSpectator) {
                    statusDiv.textContent = 'Observing';
                    statusDiv.style.color = '#6c757d';
                } else if (player.hasVoted) {
                    statusDiv.textContent = 'Voted';
                    statusDiv.style.color = '#28a745';
                } else {
                    statusDiv.textContent = 'Thinking...';
                    statusDiv.style.color = '#ffc107';
                }
                
                playerDiv.appendChild(nameDiv);
                playerDiv.appendChild(cardDiv);
                playerDiv.appendChild(statusDiv);
                container.appendChild(playerDiv);
            }
        }

        function updateVotingCards() {
            var cards = document.querySelectorAll('.fibonacci-card');
            
            var canVote = !gameState.isSpectator && !gameState.sessionState.hasConsensus;
            var isReVotingScenario = gameState.sessionState.votesRevealed && !gameState.sessionState.hasConsensus;
            
            for (var i = 0; i < cards.length; i++) {
                var card = cards[i];
                card.classList.remove('disabled', 're-vote-allowed');
                
                if (canVote) {
                    if (isReVotingScenario) {
                        card.classList.add('re-vote-allowed');
                    }
                } else {
                    card.classList.add('disabled');
                }
            }
        }

        function updateSpectatorControls() {
            var resetButton = document.getElementById('resetButton');
            
            if (!gameState.isSpectator) return;
            
            var players = gameState.sessionState.players;
            var hasVotes = false;
            
            for (var playerName in players) {
                if (players.hasOwnProperty(playerName)) {
                    var player = players[playerName];
                    if (!player.isSpectator && player.hasVoted) {
                        hasVotes = true;
                        break;
                    }
                }
            }
            
            if (hasVotes) {
                resetButton.style.display = 'block';
                
                if (gameState.sessionState.hasConsensus) {
                    resetButton.textContent = 'üÜï Start New Round';
                    resetButton.title = 'Start a new voting round';
                } else if (gameState.sessionState.votesRevealed) {
                    resetButton.textContent = 'üîÑ Reset for Re-vote';
                    resetButton.title = 'Allow players to change their votes';
                } else {
                    resetButton.textContent = 'üîÑ Reset Votes';
                    resetButton.title = 'Clear all current votes';
                }
            } else {
                resetButton.style.display = 'none';
            }
        }

        function updateSelectedVote(value) {
            var cards = document.querySelectorAll('.fibonacci-card');
            for (var i = 0; i < cards.length; i++) {
                cards[i].classList.remove('selected');
                
                if (value !== null && parseInt(cards[i].dataset.value) === value) {
                    cards[i].classList.add('selected');
                }
            }
        }

        // Utility functions
        function generateSessionCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function copyShareLink() {
            var shareUrl = document.getElementById('shareLink').getAttribute('data-url');
            
            if (!shareUrl) {
                // Fallback: create share URL from current session
                shareUrl = window.location.origin + window.location.pathname + '?session=' + gameState.sessionCode;
                console.log('üîó Generated fallback share URL:', shareUrl);
            }
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(shareUrl).then(function() {
                    showTemporaryMessage('üìã Share link copied! Send this to team members: ' + shareUrl);
                }).catch(function() {
                    fallbackCopyTextToClipboard(shareUrl);
                });
            } else {
                fallbackCopyTextToClipboard(shareUrl);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showTemporaryMessage('üìã Share link copied! Send this to team members: ' + text);
            } catch (err) {
                console.error('Fallback: Could not copy text: ', err);
                
                // Show the URL in a prompt as last resort
                prompt('Copy this share link to invite team members:', text);
            }
            
            document.body.removeChild(textArea);
        }

        function showError(message) {
            var errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            console.error('Error: ' + message);
        }

        function hideError() {
            var errorElement = document.getElementById('errorMessage');
            errorElement.style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
        }

        function showTemporaryMessage(message) {
            // Remove existing temporary messages
            var existingMessages = document.querySelectorAll('.temporary-message');
            for (var i = 0; i < existingMessages.length; i++) {
                existingMessages[i].remove();
            }
            
            // Create new message
            var messageDiv = document.createElement('div');
            messageDiv.className = 'temporary-message';
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // Auto-remove after animation
            setTimeout(function() {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }
    </script>
</body>
</html>